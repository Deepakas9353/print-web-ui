<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Print | Dashboard</title>
    <meta name="description" content="Professional print management utility for efficient job execution.">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>
    <div id="loading-overlay">
        <div class="loader-content">
            <div class="loader-visual">
                <div class="loader-circle"></div>
                <i data-lucide="printer" class="loader-icon-inner"></i>
            </div>
            <div class="loader-text">
                <h2>Syncing with Tiny Agent</h2>
                <p>Establishing secure connection and detecting system printers...</p>
            </div>
            <div class="loader-progress">
                <div class="progress-bar"></div>
            </div>
            <button class="btn-skip" onclick="hideLoadingOverlay()">
                Skip and use default settings
            </button>
        </div>
    </div>

    <header>
        <div class="header-brand">
            <h1>Elite Print <span style="color: var(--primary);">Utility</span></h1>
            <p>Manage and execute your print jobs efficiently</p>
        </div>

        <div class="header-actions">
            <div class="qr-card" title="Scan to print from mobile">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://deepakas9353.github.io/Mobile-web-app/"
                    alt="QR Code">
                <span>Scan to Print</span>
            </div>
            <button class="btn btn-primary btn-refresh" onclick="location.reload()">
                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                Refresh Data
            </button>
        </div>
    </header>

    <main class="fade-in">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Copies</th>
                        <th>Color Mode</th>
                        <th>Sides</th>
                        <th>Pages/Sheet</th>
                        <th>Printer</th>
                        <th>Upload File</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="print-jobs-body">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i data-lucide="loader-2" class="spin"
                                style="width: 24px; height: 24px; margin-bottom: 1rem;"></i>
                            <p>Fetching latest print configurations...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <div class="status-indicator">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">System Synchronized | Live WebSocket Connected</span>
        </div>
    </footer>

    <script>
        const API_URL = 'https://v49h710vzi.execute-api.us-east-1.amazonaws.com/v1/web-apis/get-order-config';
        const WS_URL = 'http://print-test-env-env.eba-9gvrcrjp.us-east-1.elasticbeanstalk.com/ws/print-events';
        const PRINTER_API = 'http://print-test-env-env.eba-9gvrcrjp.us-east-1.elasticbeanstalk.com/v1/web-apis/get-printers';
        let printers = ["Default Printer"];

        async function fetchPrinters() {
            try {
                const response = await fetch(PRINTER_API);
                if (response.ok) {
                    const data = await response.json();
                    // Treat as "detected" if it's more than just the default or if we have at least one valid printer string
                    if (data && data.length > 0 && !data.includes("Default Printer")) {
                        printers = data;
                        console.log('Real printers detected:', printers);
                        hideLoadingOverlay();
                    } else if (data && data.length > 0) {
                        printers = data;
                    }
                }
            } catch (error) {
                console.error('Error fetching printers:', error);
            }
        }

        // Poll for printers every 3 seconds until detected
        const printerPollInterval = setInterval(async () => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                await fetchPrinters();
            } else {
                clearInterval(printerPollInterval);
            }
        }, 3000);

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                overlay.classList.add('hidden');
            }
        }

        async function updatePrinter(id, printerName) {
            try {
                const url = `http://print-test-env-env.eba-9gvrcrjp.us-east-1.elasticbeanstalk.com/v1/web-apis/update-printer-selection?id=${id}&printerName=${encodeURIComponent(printerName)}`;
                const response = await fetch(url, { method: 'POST' });
                if (response.ok) {
                    console.log(`Printer for #${id} updated to ${printerName}`);
                }
            } catch (error) {
                console.error('Error updating printer:', error);
            }
        }

        // No longer updating printer in DB as requested
        function updatePrinter(id, printerName) {
            console.log(`Local selection: Order #${id} set to ${printerName}`);
        }

        async function fetchPrintJobs() {
            const tbody = document.getElementById('print-jobs-body');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderTable(data);
                statusText.textContent = 'System Synchronized | Live Data Loaded';
                statusDot.style.background = 'var(--success)';
            } catch (error) {
                console.error('Fetch error:', error);
                statusText.textContent = 'Communication Error | Using Offline Cache';
                statusDot.style.background = '#ef4444';

                // Fallback to mock data if API fails (CORS or 500)
                const mockData = [
                    { id: 1284, copies: 2, color_mode: 10, sides: 2, pages_per_sheet: 1, file_name: 'invoice_feb.pdf' },
                    { id: 1285, copies: 1, color_mode: 1, sides: 1, pages_per_sheet: 2, file_name: null },
                    { id: 1286, copies: 5, color_mode: 10, sides: 2, pages_per_sheet: 1, file_name: 'presentation_v2.png' }
                ];
                renderTable(mockData);
            }
        }

        function initWebSocket() {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');

            const socket = new SockJS(WS_URL);
            const stompClient = Stomp.over(socket);
            stompClient.debug = null; // Disable debug logging

            stompClient.connect({}, function (frame) {
                console.log('Connected to WebSocket');
                statusText.textContent = 'System Synchronized | Live WebSocket Connected';
                statusDot.style.background = 'var(--success)';

                stompClient.subscribe('/topic/print-config', function (message) {
                    if (message.body === 'NEW_PRINT_CONFIG') {
                        console.log('New print configuration detected. Re-fetching...');
                        fetchPrintJobs();
                    }
                });
            }, function (error) {
                console.error('WebSocket Error:', error);
                statusText.textContent = 'Connection Interrupted | Reconnecting...';
                statusDot.style.background = '#dc2626';
                setTimeout(initWebSocket, 5000); // Attempt to reconnect
            });
        }

        function renderTable(jobs) {
            const tbody = document.getElementById('print-jobs-body');
            tbody.innerHTML = '';

            if (!jobs || jobs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-muted);">No active print jobs found.</td></tr>`;
                return;
            }

            jobs.forEach(job => {
                const tr = document.createElement('tr');
                tr.className = 'fade-in';

                const colorBadgeClass = job.color_mode === 10 ? 'badge-color' : 'badge-bw';
                const colorText = job.color_mode === 10 ? 'Color (10)' : 'B/W (1)';
                const sideText = job.sides === 2 ? 'Front & Back' : 'Front Only';
                const fileName = job.file_name || 'None';
                const isReady = !!job.file_name || !!job.file_base64;

                tr.innerHTML = `
                    <td style="font-weight: 600;">#${job.id}</td>
                    <td>${job.copies.toString().padStart(2, '0')}</td>
                    <td><span class="badge ${colorBadgeClass}">${colorText}</span></td>
                    <td>${sideText}</td>
                    <td>${job.pages_per_sheet} Page${job.pages_per_sheet > 1 ? 's' : ''}</td>
                    <td>
                        <div class="printer-cell">
                            <select class="printer-select" data-id="${job.id}">
                                ${printers.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="upload-cell">
                            <button class="btn btn-primary btn-sm btn-upload" style="padding: 4px 8px; font-size: 0.75rem;">
                                <i data-lucide="file-up" style="width: 14px; height: 14px;"></i>
                                Attach File
                            </button>
                            <span class="filename" style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 4px;">None</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-success btn-print" data-id="${job.id}">
                            <i data-lucide="printer" style="width: 18px; height: 18px;"></i>
                            PRINT
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Re-initialize icons and event listeners
            lucide.createIcons();
            attachListeners();
        }

        function attachListeners() {
            document.querySelectorAll('.btn-upload').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        if (file) {
                            const orderId = btn.closest('tr').querySelector('td').textContent.replace('#', '');
                            const reader = new FileReader();

                            btn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width: 14px; height: 14px;"></i> Uploading...';
                            lucide.createIcons();

                            reader.onload = async () => {
                                try {
                                    const base64 = reader.result.split(',')[1];
                                    const url = `http://print-test-env-env.eba-9gvrcrjp.us-east-1.elasticbeanstalk.com/v1/web-apis/update-order-file?id=${orderId}&fileName=${encodeURIComponent(file.name)}`;
                                    const response = await fetch(url, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'text/plain' },
                                        body: base64
                                    });

                                    if (response.ok) {
                                        const cell = btn.closest('.upload-cell');
                                        cell.querySelector('.filename').textContent = file.name;
                                        const row = btn.closest('tr');
                                        const printBtn = row.querySelector('.btn-success');
                                        printBtn.disabled = false;
                                        printBtn.style.opacity = '1';
                                        printBtn.style.cursor = 'pointer';

                                        btn.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px; color: #059669;"></i> Done';
                                        setTimeout(() => {
                                            btn.innerHTML = '<i data-lucide="upload" style="width: 14px; height: 14px;"></i> Upload';
                                            lucide.createIcons();
                                        }, 3000);
                                    }
                                } catch (error) {
                                    console.error('Upload error:', error);
                                    btn.innerHTML = '<i data-lucide="alert-circle" style="width: 14px; height: 14px; color: #dc2626;"></i> Retry';
                                }
                                lucide.createIcons();
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                });
            });

            document.querySelectorAll('.btn-print').forEach(btn => {
                btn.onclick = async () => {
                    const orderId = btn.getAttribute('data-id');
                    const row = btn.closest('tr');
                    const printerName = row.querySelector('.printer-select').value;

                    btn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width: 18px; height: 18px;"></i> Sending...';
                    lucide.createIcons();

                    try {
                        const triggerUrl = `http://print-test-env-env.eba-9gvrcrjp.us-east-1.elasticbeanstalk.com/v1/web-apis/trigger-print/${orderId}?printerName=${encodeURIComponent(printerName)}`;
                        const response = await fetch(triggerUrl);

                        if (response.ok) {
                            btn.innerHTML = '<i data-lucide="check" style="width: 18px; height: 18px;"></i> Sent';
                            btn.style.background = 'var(--success)';
                        } else {
                            throw new Error('Trigger failed');
                        }
                    } catch (error) {
                        console.error('Print trigger error:', error);
                        btn.innerHTML = '<i data-lucide="alert-circle" style="width: 18px; height: 18px;"></i> Fail';
                        btn.style.background = '#dc2626';
                    }

                    setTimeout(() => {
                        btn.innerHTML = '<i data-lucide="printer" style="width: 18px; height: 18px;"></i> PRINT';
                        btn.style.background = '';
                        lucide.createIcons();
                    }, 2000);
                };
            });
        }

        // Initialize
        lucide.createIcons();
        fetchPrinters().then(() => fetchPrintJobs());
        initWebSocket();

        // Refresh button logic
        document.querySelector('.btn-refresh').addEventListener('click', () => {
            const btn = document.querySelector('.btn-refresh');
            const icon = btn.querySelector('i');
            icon.classList.add('spin');
            fetchPrintJobs().finally(() => {
                setTimeout(() => icon.classList.remove('spin'), 500);
            });
        });
    </script>

    <style>
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .status-indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-idle {
            background-color: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .status-printing {
            background-color: #f59e0b;
            box-shadow: 0 0 8px #f59e0b;
            animation: pulse 1.5s infinite;
        }

        .status-stopped {
            background-color: #ef4444;
            box-shadow: 0 0 8px #ef4444;
        }

        .status-unknown {
            background-color: #94a3b8;
        }

        .printer-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
        }

        /* Animations */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }
    </style>
</body>

</html>